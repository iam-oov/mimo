<!-- 
Ejemplo de integraci√≥n del an√°lisis multi-agente en la interfaz
Este c√≥digo se puede agregar a templates/calculator.html
-->

<style>
.multi-agent-section {
    margin-top: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

.multi-agent-button {
    background: white;
    color: #667eea;
    padding: 1rem 2rem;
    border-radius: 8px;
    border: none;
    font-weight: bold;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.multi-agent-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
}

.multi-agent-button:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.analysis-container {
    margin-top: 1.5rem;
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    max-height: 600px;
    overflow-y: auto;
}

.expert-card {
    background: #f8f9fa;
    padding: 1rem;
    margin: 0.5rem 0;
    border-left: 4px solid #667eea;
    border-radius: 4px;
}

.phase-indicator {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #667eea;
    color: white;
    border-radius: 20px;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.intervention {
    margin: 1rem 0;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.intervention-header {
    font-weight: bold;
    color: #667eea;
    margin-bottom: 0.5rem;
}

.moderator-text {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
}

.voting-results {
    background: #d4edda;
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
}

.conclusion {
    background: #d1ecf1;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 4px solid #0c5460;
    margin-top: 1rem;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<!-- Secci√≥n en el HTML -->
<div class="multi-agent-section">
    <h2 style="color: white; margin-bottom: 1rem;">üê± An√°lisis Multi-Agente Mimo</h2>
    <p style="color: white; margin-bottom: 1rem;">
        3 expertos fiscales debaten c√≥mo optimizar tu situaci√≥n fiscal.
        Cada experto tiene una personalidad y profesi√≥n √∫nica asignada aleatoriamente.
    </p>
    
    <button id="startMultiAgentBtn" class="multi-agent-button" onclick="startMultiAgentAnalysis()">
        <span id="buttonText">üöÄ Iniciar An√°lisis Multi-Agente</span>
        <span id="buttonSpinner" class="loading-spinner" style="display:none;"></span>
    </button>
    
    <div id="analysisContainer" class="analysis-container" style="display:none;">
        <div id="expertProfiles"></div>
        <div id="analysisContent"></div>
    </div>
</div>

<script>
// Configuraci√≥n
const API_ENDPOINT = '/api/multi-agent-analysis/stream';

// Estado global
let isAnalyzing = false;

function startMultiAgentAnalysis() {
    if (isAnalyzing) return;
    
    // Obtener datos del formulario (ajustar seg√∫n tu form)
    const formData = {
        taxpayer_name: document.getElementById('taxpayerName')?.value || 'Contribuyente',
        fiscal_year: parseInt(document.getElementById('fiscalYear')?.value || '2025'),
        monthly_gross_income: parseFloat(document.getElementById('monthlyIncome')?.value || '0'),
        monthly_net_income: parseFloat(document.getElementById('netIncome')?.value || '0'),
        bonus_days: parseInt(document.getElementById('bonusDays')?.value || '15'),
        vacation_days: parseInt(document.getElementById('vacationDays')?.value || '12'),
        vacation_premium_percentage: parseFloat(document.getElementById('vacationPremium')?.value || '0.25'),
        general_deductions: parseFloat(document.getElementById('generalDeductions')?.value || '0'),
        total_tuition: parseFloat(document.getElementById('tuition')?.value || '0'),
        total_ppr: parseFloat(document.getElementById('ppr')?.value || '0')
    };
    
    // Iniciar an√°lisis
    isAnalyzing = true;
    updateButtonState(true);
    showAnalysisContainer();
    
    // Streaming con Server-Sent Events
    const eventSource = new EventSource(API_ENDPOINT);
    let currentIntervention = null;
    
    eventSource.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            handleAnalysisEvent(data);
        } catch (error) {
            console.error('Error parsing event:', error);
        }
    };
    
    eventSource.onerror = (error) => {
        console.error('EventSource error:', error);
        eventSource.close();
        isAnalyzing = false;
        updateButtonState(false);
        showError('Error en la conexi√≥n. Por favor intenta nuevamente.');
    };
    
    // Enviar datos via fetch primero
    fetch(API_ENDPOINT, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    }).catch(error => {
        console.error('Error starting analysis:', error);
        eventSource.close();
        isAnalyzing = false;
        updateButtonState(false);
    });
}

function handleAnalysisEvent(data) {
    const container = document.getElementById('analysisContent');
    
    switch(data.type) {
        case 'initialization':
            displayExpertProfiles(data.experts);
            break;
            
        case 'phase':
            displayPhase(data.phase);
            break;
            
        case 'chunk':
            appendChunk(data.agent, data.content);
            break;
            
        case 'intervention_complete':
            completeIntervention();
            break;
            
        case 'voting_results':
            displayVotingResults(data.results);
            break;
            
        case 'complete':
            displayConclusion(data.conclusion);
            isAnalyzing = false;
            updateButtonState(false);
            break;
            
        case 'error':
            showError(data.message);
            isAnalyzing = false;
            updateButtonState(false);
            break;
    }
}

function displayExpertProfiles(experts) {
    const container = document.getElementById('expertProfiles');
    container.innerHTML = '<h3>üë• Expertos Participantes:</h3>';
    
    experts.forEach(expert => {
        container.innerHTML += `
            <div class="expert-card">
                <strong>${expert.name}</strong> - ${expert.profession}
                <br>
                <small>Personalidad: ${expert.personality}</small>
            </div>
        `;
    });
}

function displayPhase(phase) {
    const container = document.getElementById('analysisContent');
    const phaseNames = {
        'introduction': 'üì¢ Introducci√≥n',
        'round_1': 'üîÑ Ronda 1',
        'round_2': 'üîÑ Ronda 2',
        'round_3': 'üîÑ Ronda 3',
        'voting': 'üó≥Ô∏è Votaci√≥n',
        'conclusion': '‚úÖ Conclusi√≥n'
    };
    
    container.innerHTML += `
        <div style="margin: 1.5rem 0;">
            <span class="phase-indicator">${phaseNames[phase] || phase}</span>
        </div>
    `;
}

let currentInterventionElement = null;
let currentAgent = null;

function appendChunk(agent, content) {
    const container = document.getElementById('analysisContent');
    
    // Si es un nuevo agente, crear nueva intervenci√≥n
    if (agent !== currentAgent) {
        currentAgent = agent;
        const isModerator = agent.includes('Moderador');
        
        currentInterventionElement = document.createElement('div');
        currentInterventionElement.className = `intervention ${isModerator ? 'moderator-text' : ''}`;
        currentInterventionElement.innerHTML = `
            <div class="intervention-header">${agent}</div>
            <div class="intervention-content"></div>
        `;
        container.appendChild(currentInterventionElement);
    }
    
    // Agregar contenido
    if (currentInterventionElement) {
        const contentDiv = currentInterventionElement.querySelector('.intervention-content');
        contentDiv.textContent += content;
    }
    
    // Auto-scroll al final
    container.scrollTop = container.scrollHeight;
}

function completeIntervention() {
    currentInterventionElement = null;
    currentAgent = null;
}

function displayVotingResults(results) {
    const container = document.getElementById('analysisContent');
    
    let votesHtml = '<h4>Votos:</h4><ul>';
    results.votes.forEach(vote => {
        votesHtml += `<li><strong>${vote.voter}</strong> vot√≥ por <strong>${vote.voted_for}</strong></li>`;
    });
    votesHtml += '</ul>';
    
    container.innerHTML += `
        <div class="voting-results">
            <h3>üèÜ Resultados de Votaci√≥n</h3>
            ${votesHtml}
            <p><strong>Estrategia Ganadora:</strong> ${results.winner}</p>
            <p><em>${results.winning_strategy}</em></p>
        </div>
    `;
    
    container.scrollTop = container.scrollHeight;
}

function displayConclusion(conclusion) {
    const container = document.getElementById('analysisContent');
    
    container.innerHTML += `
        <div class="conclusion">
            <h3>üéØ Conclusi√≥n Final</h3>
            <p>${conclusion}</p>
        </div>
    `;
    
    container.scrollTop = container.scrollHeight;
}

function showError(message) {
    const container = document.getElementById('analysisContent');
    container.innerHTML += `
        <div style="background:#f8d7da; padding:1rem; border-radius:8px; color:#721c24; margin:1rem 0;">
            <strong>‚ùå Error:</strong> ${message}
        </div>
    `;
}

function updateButtonState(analyzing) {
    const button = document.getElementById('startMultiAgentBtn');
    const text = document.getElementById('buttonText');
    const spinner = document.getElementById('buttonSpinner');
    
    if (analyzing) {
        button.disabled = true;
        text.textContent = 'Analizando...';
        spinner.style.display = 'inline-block';
    } else {
        button.disabled = false;
        text.textContent = 'üöÄ Iniciar An√°lisis Multi-Agente';
        spinner.style.display = 'none';
    }
}

function showAnalysisContainer() {
    const container = document.getElementById('analysisContainer');
    container.style.display = 'block';
    document.getElementById('expertProfiles').innerHTML = '';
    document.getElementById('analysisContent').innerHTML = '';
}
</script>
