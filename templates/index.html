<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Tax Balance Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; color: #333; }
        .header { text-align: center; border-bottom: 3px solid #2c5530; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #2c5530; margin: 0; font-size: 24px; }
        .header h2 { color: #666; margin: 5px 0; font-size: 18px; font-weight: normal; }
        .info-section { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .info-section h3 { color: #2c5530; margin-top: 0; border-bottom: 1px solid #dee2e6; padding-bottom: 5px; }
        .calculation-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .calculation-table th, .calculation-table td { border: 1px solid #dee2e6; padding: 10px; text-align: left; }
        .calculation-table th { background-color: #2c5530; color: white; font-weight: bold; }
        .calculation-table .amount { text-align: right; font-family: 'Courier New', monospace; }
        .highlight { background-color: #d4edda; font-weight: bold; }
        .saldo-favor { background-color: #d1ecf1; border: 2px solid #bee5eb; padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0; }
        .saldo-favor h3 { color: #0c5460; margin: 0; font-size: 20px; }
        .saldo-favor .amount { font-size: 28px; font-weight: bold; color: #155724; font-family: 'Courier New', monospace; }
        .saldo-pagar { background-color: #f8d7da; border: 2px solid #f5c6cb; padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0; }
        .saldo-pagar h3 { color: #721c24; margin: 0; font-size: 20px; }
        .saldo-pagar .amount { font-size: 28px; font-weight: bold; color: #721c24; font-family: 'Courier New', monospace; }
        .recommendations { background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 20px; border-radius: 5px; margin-top: 30px; }
        .recommendations h3 { color: #856404; margin-top: 0; }
        .recommendations ul { margin: 10px 0; padding-left: 20px; }
        .recommendations li { margin-bottom: 10px; text-align: justify; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; text-align: center; color: #666; font-size: 12px; }
        .deduction-header td { background-color: #e9ecef; font-weight: bold; color: #495057; }
        .deduction-detail td { background-color: #f8f9fa; color: #6c757d; font-size: 14px; }
        .deduction-total td { background-color: #d4edda; font-weight: bold; color: #155724; border-top: 2px solid #c3e6cb; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Tax Balance Report</h1>
        <h2 id="fiscal_year"></h2>
        <p><strong>Taxpayer:</strong> <span id="taxpayer_name"></span></p>
        <div id="auth-controls">
            {% if user %}
                <p>Welcome, {{ user.name }}! (<a href="/logout">Logout</a>)</p>
                <button id="get_recommendations">Get Recommendations</button>
            {% else %}
                <a href="/auth/google">Login with Google</a>
            {% endif %}
        </div>
    </div>

    <div class="info-section">
        <h3>Income Summary</h3>
        <table class="calculation-table">
            <thead>
                <tr><th>Concept</th><th>Amount</th></tr>
            </thead>
            <tbody id="income_summary_table">
            </tbody>
        </table>
    </div>

    <div class="info-section">
        <h3>Tax Calculation</h3>
        <table class="calculation-table">
            <thead>
                <tr><th>Concept</th><th>Amount</th></tr>
            </thead>
            <tbody id="tax_calculation_table">
            </tbody>
        </table>
    </div>

    <div id="balance_result">
    </div>

    <div class="recommendations">
        <h3>üéØ Fiscal Recommendations</h3>
        <ul id="recommendations_list">
        </ul>
    </div>

    <div class="footer">
        <p>Report generated automatically ‚Ä¢ <span id="generation_date"></span></p>
        <p>This document is a projection based on the data provided</p>
    </div>

    <script>
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        }

        fetch("/api/calculate")
            .then(response => response.json())
            .then(data => {
                document.getElementById("fiscal_year").innerText = new Date().getFullYear();
                document.getElementById("taxpayer_name").innerText = "EG"; // Hardcoded for now

                let incomeSummaryTable = document.getElementById("income_summary_table");
                incomeSummaryTable.innerHTML = `
                    <tr><td>Gross Annual Income</td><td class="amount">${formatCurrency(data.gross_annual_income)}</td></tr>
                    <tr><td>Taxable Bonus</td><td class="amount">${formatCurrency(data.taxable_bonus)}</td></tr>
                    <tr><td>Taxable Vacation Premium</td><td class="amount">${formatCurrency(data.taxable_vacation_premium)}</td></tr>
                    <tr class="highlight"><td><strong>Total Taxable Income</strong></td><td class="amount"><strong>${formatCurrency(data.total_taxable_income)}</strong></td></tr>
                `;

                let taxCalculationTable = document.getElementById("tax_calculation_table");
                taxCalculationTable.innerHTML = `
                    <tr class="deduction-header"><td colspan="2"><strong>Authorized Deductions</strong></td></tr>
                    <tr class="deduction-detail"><td>&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ Personal Deductions</td><td class="amount">${formatCurrency(data.personal_deductions)}</td></tr>
                    <tr class="deduction-detail"><td>&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ PPR Contributions</td><td class="amount">${formatCurrency(data.ppr_deductions)}</td></tr>
                    <tr class="deduction-detail"><td>&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ Education Expenses</td><td class="amount">${formatCurrency(data.education_deductions)}</td></tr>
                    <tr class="deduction-total"><td><strong>Total Authorized Deductions</strong></td><td class="amount"><strong>${formatCurrency(data.authorized_deductions)}</strong></td></tr>
                    <tr><td>Taxable Base</td><td class="amount">${formatCurrency(data.taxable_base)}</td></tr>
                    <tr><td>Determined Tax</td><td class="amount">${formatCurrency(data.determined_tax)}</td></tr>
                    <tr><td>Withheld Tax</td><td class="amount">${formatCurrency(data.withheld_tax)}</td></tr>
                `;

                let balanceResult = document.getElementById("balance_result");
                if (data.balance_in_favor > 0) {
                    balanceResult.innerHTML = `<div class="saldo-favor"><h3>üí∞ Balance in Favor</h3><div class="amount">${formatCurrency(data.balance_in_favor)}</div></div>`;
                } else if (data.balance_to_pay > 0) {
                    balanceResult.innerHTML = `<div class="saldo-pagar"><h3>‚ö†Ô∏è Balance to Pay</h3><div class="amount">${formatCurrency(data.balance_to_pay)}</div></div>`;
                } else {
                    balanceResult.innerHTML = `<div class="saldo-favor"><h3>‚öñÔ∏è No Balance</h3><div class="amount">$0.00</div></div>`;
                }

                document.getElementById("generation_date").innerText = new Date().toLocaleString();
            });

        const getRecommendationsButton = document.getElementById("get_recommendations");
        if (getRecommendationsButton) {
            getRecommendationsButton.addEventListener("click", function() {
                fetch("/api/recommendations")
                    .then(response => {
                        if (response.status === 429) {
                            alert("Rate limit exceeded. Please try again later.");
                            return;
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data) {
                            let recommendationsList = document.getElementById("recommendations_list");
                            recommendationsList.innerHTML = data.recommendations.join("");
                        }
                    });
            });
        }
    </script>
</body>
</html>
